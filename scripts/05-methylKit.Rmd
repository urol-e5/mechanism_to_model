---
title: "DML using methylkit"
author: "Zoe Dellaert"
date: "10/02/2024"
output: github_document
---

I am identifying differentially methylated loci using methylkit based on [Yaamini Venkataraman's code](https://osf.io/u46xj)

# Prepare R Markdown file

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/project/pi_hputnam_uri_edu/mechanism_to_model/output/05-methylKit/") #Set root directory
```

# Process bam files for methylkit, on unity

to go to interactive mode in unity: `salloc -p cpu -c 8 --mem 32G`

```{bash}
#!/usr/bin/env bash
#SBATCH --export=NONE
#SBATCH --nodes=1 --ntasks-per-node=30
#SBATCH --signal=2
#SBATCH --no-requeue
#SBATCH --mem=100GB
#SBATCH --error="outs_errs/%x_error.%j"
#SBATCH --output="outs_errs/%x_output.%j"
#SBATCH -t 24:00:00
#SBATCH --mail-type=BEGIN,END,FAIL

# load modules needed

module load uri/main
module load all/Bismark/0.23.1-foss-2021b
module load SAMtools/1.18-GCC-12.3.0

#Sort for Downstream Applications

cd ../data/WGBS/

mkdir ../../output/05-methylKit/bismark

find *deduplicated.bam | \
xargs basename -s .bam | \
xargs -I{} samtools \
sort --threads 28 {}.bam \
-o ../../output/05-methylKit/bismark/{}.sorted.bam

#Index for Downstream Applications

cd ../../output/05-methylKit/bismark/

find *.sorted.bam | \
xargs basename -s .sorted.bam | \
xargs -I{} samtools \
index -@ 28 {}.sorted.bam

# Generate Bismark HTML processing report
bismark2report

# Generate Bismark summary report
bismark2summary
```




# Install packages to run methylkit

```{r}
#Packages for running methylKit

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("methylKit")
require(methylKit)

#install.packages("tidyverse")
require(tidyverse)
```

```{r}
#Packages for visualization

#install.packages("vegan")
#install.packages("gplots")
#install.packages("dichromat")

require(vegan)
require(gplots)
require(dichromat)
```

# Obtain session information

```{r}
sessionInfo()
```

```{r}

```

## Appendix

Moving Danielle files to unity from Andromeda:

https://daniellembecker.github.io/DanielleBecker_Lab_Notebook/Data-Transfer-Andromeda-GlobusConnectPersonal-Pipeline/

in Andromeda:

```{bash}
interactive
module load GlobusConnectPersonal/3.2.0
#follow the login link, enter auth code, enter "~/data/putnamlab/" as endpoint
nano ~/.globusonline/lta/config-paths
```

```
/data/putnamlab/,0,1 # Read-write access to the putnamlab directory
```

```{bash}
globusconnectpersonal -start &
```

On Globus Connect in your browser (https://www.globus.org):
- Login
- Select your university and login
- Go to the File Manager and in the Collection field on the left, enter the personal endpoint string that was spit out by the globus setup above 
- Select acda5457-9c06-4564-8375-260ba428f22a (exact address of Unity) in the collection field on the right
- Select the files or folders you want to transfer from Andromeda to Unity and press ‘Start’.
  - navigating to `/data/putnamlab/dbecks/Becker_E5/WGBS_Becker_E5/Becker_WGBS/bismark_deduplicated/` in andromeda and `/project/pi_hputnam_uri_edu/WGBS_mech_model/` in unity
  

